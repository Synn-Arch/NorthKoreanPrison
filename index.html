<!DOCTYPE html>
<html>
<head>
  <title>GeoJSON Import and Selection</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    body {
      display: flex;
      flex-direction: row;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }
    #map {
      width: 70%;
      height: 100%;
    }
    #chartContainer {
      width: 30%;
      padding: 20px;
      background-color: #f9f9f9;
      box-shadow: -3px 0px 5px rgba(0,0,0,0.2);
    }
    canvas {
      max-width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="chartContainer">
    <h3>Selected Data Visualization</h3>
    <canvas id="chart"></canvas>
    <div id="statistics"></div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Initialize the map
    const map = L.map('map').setView([40.7128, -74.0060], 13); // Default view

    // Add a tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Variable to hold the loaded GeoJSON data
    let geojsonLayer;
    let drawnRectangle = null;

    // Initialize Chart.js
    const ctx = document.getElementById('chart').getContext('2d');
    let chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Value 1',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Value 2',
            data: [],
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top'
          },
          tooltip: {
            callbacks: {
              footer: (tooltipItems) => {
                let sum = 0;
                tooltipItems.forEach(item => sum += item.raw);
                return `Sum: ${sum}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // Update chart data
    function updateChart(selectedData) {
      const labels = selectedData.map((_, index) => `Point ${index + 1}`);
      const value1 = selectedData.map(d => d.properties.value1);
      const value2 = selectedData.map(d => d.properties.value2);

      // Update chart data
      chart.data.labels = labels;
      chart.data.datasets[0].data = value1;
      chart.data.datasets[1].data = value2;
      chart.update();

      // Calculate statistics
      const total1 = value1.reduce((sum, val) => sum + val, 0);
      const total2 = value2.reduce((sum, val) => sum + val, 0);
      const avg1 = (total1 / value1.length).toFixed(2);
      const avg2 = (total2 / value2.length).toFixed(2);

      // Update statistics panel
      document.getElementById('statistics').innerHTML = `
        <h4>Statistics:</h4>
        <p><b>Total Value 1:</b> ${total1}</p>
        <p><b>Average Value 1:</b> ${avg1}</p>
        <p><b>Total Value 2:</b> ${total2}</p>
        <p><b>Average Value 2:</b> ${avg2}</p>
      `;
    }

    // Add Leaflet Draw Controls
    const drawControl = new L.Control.Draw({
      draw: {
        rectangle: true, // Enable rectangle drawing
        polygon: false,
        circle: false,
        polyline: false,
        marker: false
      }
    });
    map.addControl(drawControl);

    // Handle draw:created event
    map.on('draw:created', function (e) {
      const layer = e.layer; // Get the drawn layer
      const bounds = layer.getBounds(); // Get the rectangle's bounds

      // Remove existing rectangle
      if (drawnRectangle) {
        map.removeLayer(drawnRectangle);
      }
      drawnRectangle = layer.addTo(map);

      // Filter GeoJSON data within the selected bounds
      const selectedData = [];
      geojsonLayer.eachLayer(function (layer) {
        if (bounds.contains(layer.getLatLng())) {
          selectedData.push(layer.feature);
        }
      });

      // Update chart and statistics
      updateChart(selectedData);
    });

    // Load GeoJSON data
    fetch('rev_filtered_north_korea_data.geojson') // Replace 'data.geojson' with your GeoJSON file path
      .then(response => response.json())
      .then(data => {
        // Add GeoJSON layer to the map
        geojsonLayer = L.geoJson(data, {
          onEachFeature: function (feature, layer) {
            // Add popup with feature properties
            layer.bindPopup(`Value1: ${feature.properties.value1}<br>Value2: ${feature.properties.value2}`);
          },
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
              radius: 6,
              fillColor: "#0077cc",
              color: "#005bb5",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            });
          }
        }).addTo(map);
      })
      .catch(error => console.error('Error loading GeoJSON:', error));
  </script>
</body>
</html>
